---
layout: post
title: "[TIL] 2025-04-22 / "
date: 2025-04-22 20:20:00 +0900
categories: 
  - til
  - main-camp
---

* toc
{:toc}

## 📖 Today I Learned
### 

<!-- <h4> 📃 </h4> -->

---

#### - 


1. [문제 인식 및 정의]

2. [해결 방안]
	2-1. [의사결정 과정]
	2-2. [해결 과정]
	
3. [해결 완료]
	3-1. [회고]
	3-2. [전후 데이터 비교]




----------------------------------------------------------------------------------------------------------
JwtFilter
```java
if (url.startsWith("/admin")) {
                // 관리자 권한이 없는 경우 403을 반환합니다.
                if (!UserRole.ADMIN.equals(userRole)) {
                    httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN, "관리자 권한이 없습니다.");
                    return;
                }
                chain.doFilter(request, response);
                return;
            }
```
if 문이 2번이나 들어갈 필요가 없어보임

if 문을 하나로 합치면 chain.doFilter 또한 없어져도 될거 같음.

```java
if (url.startsWith("/admin") && !UserRole.ADMIN.equals(userRole)) {
                httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN, "관리자 권한이 없습니다.");

                return;
            }
```


----------------------------------------------------------------------------------------------------------

SignupRequest

```java
@NotBlank @Email
    private String email;
```

@Email 어노테이션은 이메일 형식에 test@test 처럼 뒤에 . 이 없어도 통과 가능

```java
@NotBlank
    @Pattern(regexp="^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])+[.][a-zA-Z]{2,3}$", message = "이메일 형식이 아닙니다.")
    private String email;
````

정규 표현식으로 바꾸면 불가능


----------------------------------------------------------------------------------------------------------


```java
@NotBlank
    private String password;
```

비밀번호 최소 조건 추가

```java
@NotBlank
    @Pattern(regexp = "^[a-zA-Z0-9!@#$%^&*]{8,16}$", message = "비밀번호는 8 ~ 16자의 영문 대소문자, 숫자, 특수문자로 이루어져야 합니다.")
    private String password;
```



----------------------------------------------------------------------------------------------------------

commentRepository
```java
@Query("SELECT c FROM Comment c JOIN FETCH c.user WHERE c.todo.id = :todoId")
    List<Comment> findByTodoIdWithUser(@Param("todoId") Long todoId);
```

managerRepository
```java
@Query("SELECT m FROM Manager m JOIN FETCH m.user WHERE m.todo.id = :todoId")
    List<Manager> findByTodoIdWithUser(@Param("todoId") Long todoId);
```

가독성 및 유지보수 향상

```java
@EntityGraph(attributePaths = {"user", "todo"})
    List<Comment> findByTodoId(Long todoId);
```

```java
@EntityGraph(attributePaths = {"user", "todo"})
    List<Manager> findByTodoId(Long todoId);
```


----------------------------------------------------------------------------------------------------------
ManagerService
UserService
```java
ObjectUtils.nullSafeEquals()
```

```java
passwordEncoder.matches()
```

자주 사용되는 거 같아 메서드화

```java
public boolean nullSafeEqual(Long firstId, Long secondId) {
        return ObjectUtils.nullSafeEquals(firstId, secondId);
    }
```

```java
public boolean isMatchesPassword(String firstPassword, String secondPassword) {
        return passwordEncoder.matches(firstPassword, secondPassword);
    }
```

----------------------------------------------------------------------------------------------------------
UserAdminController
UserController
```java
@PutMapping("/users")
    public void changePassword(@Auth AuthUser authUser, @RequestBody UserChangePasswordRequest userChangePasswordRequest) {
        userService.changePassword(authUser.getId(), userChangePasswordRequest);
    }
```
```java
@PatchMapping("/admin/users/{userId}")
    public void changeUserRole(@PathVariable("userId") long userId, @RequestBody UserRoleChangeRequest userRoleChangeRequest) {
        userAdminService.changeUserRole(userId, userRoleChangeRequest);
    }
```

dto의 bean validation을 사용하여 검증하기 위해 @Valid 추가

```java
@PutMapping("/users")
    public void changePassword(@Auth AuthUser authUser, @Valid @RequestBody UserChangePasswordRequest userChangePasswordRequest) {
        userService.changePassword(authUser.getId(), userChangePasswordRequest);
    }
```

```java
@PatchMapping("/admin/users/{userId}")
    public void changeUserRole(@PathVariable("userId") long userId, @Valid @RequestBody UserRoleChangeRequest userRoleChangeRequest) {
        userAdminService.changeUserRole(userId, userRoleChangeRequest);
    }
```

----------------------------------------------------------------------------------------------------------
UserRoleChangeRequest

역할을 공백으로 보내는 것을 막기 위해 
@NotNull 추가

```java
@NotNull
    private String role;
```

----------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------------







<!-- --- -->

<!-- <h2> 💬 </h2> -->

<!-- <h4>  </h4> -->


jpa 상속관계 매핑 전략 사용 이유
MappedSuper
JOIN FETCH

.빌드 그래들 -> 인텔리제이
어림짐작해서 그래들 맞는 버전

서버 킬떄는 그래들로


API 로깅 시 
AOP VS 인터셉터 VS 필터?


팩토리를 테스트안에서 선언
해당 팩토리에 내가 넣고싶은 프록시를 넣음
팩토리에서 프록시를 얻을수 있음
그 객체로 테스트


aspectJProxyFactory

https://mopil.tistory.com/127