---
layout: post
title: "[TIL] 2025-06-18 / SQL ë°ì´í„° ë¡œë“œ ë° ëª¨ë¸ í•™ìŠµ"
date: 2025-06-18 21:00:00 +0900
categories:
  - til
  - main-camp
---

* toc
{:toc}

## ğŸ“– Today I Learned
### SQL ë°ì´í„° ë¡œë“œ ë° ëª¨ë¸ í•™ìŠµ

---

#### - **ì‘ì—… ê°œìš”**

```python
import json
import pandas as pd
from sqlalchemy import create_engine
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import MultiLabelBinarizer
from sklearn.neural_network import MLPRegressor
from sklearn.metrics import mean_squared_error
import joblib

# 1) SQLAlchemy ì—”ì§„ ìƒì„±
engine = create_engine(
    "mysql+pymysql://root:2103@localhost:3306/mlp_db?charset=utf8mb4"
)

# 2) í…Œì´ë¸” ë°ì´í„° ì½ì–´ì˜¤ê¸°
df = pd.read_sql_table("mlp_learning", engine)

# 3) Duration ê³„ì‚° (ì‹œê°„ ë‹¨ìœ„)
df["start_at"]   = pd.to_datetime(df["start_at"])
df["end_at"]     = pd.to_datetime(df["end_at"])
df["duration_h"] = (df["end_at"] - df["start_at"]).dt.total_seconds() / 3600

# 4) option_list íŒŒì‹±
def parse_opts(x):
    if isinstance(x, list):
        return x
    if isinstance(x, str):
        try:
            return json.loads(x)
        except json.JSONDecodeError:
            return []
    return []

opts = df["option_list"].apply(parse_opts)

# 5) ì˜µì…˜ ì›-í•« ì¸ì½”ë”©
mlb = MultiLabelBinarizer(classes=[1,2,3,4,5])
opt_df = pd.DataFrame(
    mlb.fit_transform(opts),
    columns=[f"opt_{i}" for i in mlb.classes_],
    index=df.index
)

# 6) ë°ì´í„° ê²°í•© ë° ë²”ì£¼í˜• ì¸ì½”ë”©
df = pd.concat([df, opt_df], axis=1)
df = pd.get_dummies(df, columns=["model_type", "stage"], drop_first=True)

# 7) íŠ¹ì„±Â·íƒ€ê²Ÿ ë¶„ë¦¬
feature_cols = [
    c for c in df.columns
    if c.startswith("opt_")
    or c.startswith("model_type_")
    or c.startswith("stage_")
    or c == "transport_delay_hours"
]
X = df[feature_cols].fillna(0)
y = df["duration_h"]

# â˜… ì»¬ëŸ¼ ì´ë¦„ì„ ë¬¸ìì—´ë¡œ ëª…ì‹œì  ë³€í™˜
X.columns = list(map(str, X.columns))

# 8) í•™ìŠµ/ê²€ì¦ ë°ì´í„° ë¶„ë¦¬
X_train, X_val, y_train, y_val = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# 9) MLPRegressor ëª¨ë¸ í•™ìŠµ
mlp = MLPRegressor(
    hidden_layer_sizes=(100,50),
    activation='relu',
    solver='adam',
    learning_rate_init=0.001,
    max_iter=200,
    random_state=42
)
# numpy arrayë¡œ ì „ë‹¬í•˜ì—¬ feature-name ê²€ì¦ ìš°íšŒ
mlp.fit(X_train.values, y_train)

# 10) ê²€ì¦ RMSE ê³„ì‚°
y_pred = mlp.predict(X_val.values)
mse = mean_squared_error(y_val, y_pred)
rmse = mse ** 0.5
print(f"Validation RMSE: {rmse:.4f}")

# 11) ëª¨ë¸ ì €ì¥
joblib.dump(mlp, "process_time_mlp2.pkl")
print("Saved MLP model to process_time_mlp.pkl")
```
