---
layout: post
title: "[TIL] 2025-07-03 / RabbitMQë¥¼ í†µí•œ ìƒë‹´ ìš”ì²­ ë©”ì¼ ì•Œë¦¼"
date: 2025-07-03 20:00:00 +0900
categories:
  - til
  - backend
---

* toc
{:toc}

## ğŸ“– Today I Learned
### RabbitMQë¥¼ í†µí•œ ìƒë‹´ ìš”ì²­ ì‹œ ë©”ì¼ ì•Œë¦¼

---

#### - ê°œìš”
- ì‚¬ìš©ì ìƒë‹´ ìš”ì²­ ë°œìƒ ì‹œ **ë¹„ë™ê¸° ë©”ì‹œì§•**ìœ¼ë¡œ ë©”ì¼ ì•Œë¦¼ ì²˜ë¦¬
- RabbitMQ íì— ë©”ì‹œì§€ ë°œí–‰ â†’ ì†Œë¹„ì ì„œë¹„ìŠ¤ì—ì„œ Dealerì—ê²Œ ë©”ì¼ ì „ì†¡

#### - êµ¬ì„± ìš”ì†Œ
- **Producer**: ìƒë‹´ ìš”ì²­ API
  - `RabbitTemplate.convertAndSend("counsel.exchange", "counsel.routing", dto)`
- **Exchange & Queue**
  - `DirectExchange payloadExchange = new DirectExchange("counsel.exchange");`
  - `Queue counselQueue = QueueBuilder.durable("counsel.queue").build();`
  - `Binding binding = BindingBuilder.bind(counselQueue).to(payloadExchange).with("counsel.routing");`
- **Consumer**: `@RabbitListener(queues = "counsel.queue")`
- **ë©”ì¼ ì„œë¹„ìŠ¤**: `JavaMailSender`ë¡œ `SimpleMailMessage` ìƒì„±Â·ì „ì†¡

#### - ì²˜ë¦¬ íë¦„
1. `CounselController`ì—ì„œ `/counsel` POST ìš”ì²­ ì²˜ë¦¬ ë° ìƒë‹´ ì •ë³´ DB ì €ì¥
2. `CounselService`ê°€ `RabbitTemplate`ìœ¼ë¡œ ë©”ì‹œì§€ ë°œí–‰
3. `CounselListener`ê°€ íë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
4. `MailService.sendCounselEmail()` í˜¸ì¶œí•´ Dealer ì´ë©”ì¼ ì „ì†¡

#### - ê°„ë‹¨ ì½”ë“œ ì˜ˆì‹œ

```java
@Service
public class CounselService {
    private final RabbitTemplate rabbitTemplate;

    public void requestCounsel(CounselDto dto) {
        // ìƒë‹´ ì •ë³´ ì €ì¥ ë¡œì§ ìƒëµ
        rabbitTemplate.convertAndSend(
            "counsel.exchange", "counsel.routing", dto
        );
    }
}

@Component
public class CounselListener {
    private final MailService mailService;

    @RabbitListener(queues = "counsel.queue")
    public void handleCounselRequest(CounselDto dto) {
        mailService.sendCounselEmail(dto);
    }
}
```

#### - ì£¼ì˜ì‚¬í•­
- **Idempotency**: ë©”ì‹œì§€ ì¤‘ë³µ ì†Œë¹„ ë°©ì§€ ë¡œì§ í•„ìš”
- **DLQ ì„¤ì •**: ì²˜ë¦¬ ì‹¤íŒ¨ ë©”ì‹œì§€ëŠ” Dead Letter Queueë¡œ ì´ë™
- **ì¬ì‹œë„ ì •ì±…**: `RetryTemplate` í˜¹ì€ `spring-retry` í™œìš©
- **ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨** ëŒ€ë¹„ fallback ë¡œì§ ì„¤ê³„

---

